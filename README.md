# Zephyr AI projects using CMSIS Stream

## Introduction 

Example of use of CMSIS Stream to implement AI + audio + video apps on Alif E7 AppKit board (it should work on E8 with some adaptation).

Several demos are implemented in this application and you can read more details about them [here](doc/demos.md).

It is possible to context switch between the demos by using the Zephyr shell command `switch`.


Technical details about the demo are [here](doc/tech_details.md).

This version of the demo uses the CMSIS Stream Zephyr module.

You can add it to your west file with:
```
- name: cmsisstream
  url: https://github.com/ARM-software/CMSIS-Stream
  revision: main
  path: modules/lib/cmsisstream
```

## How to change the demo 

The demo is built with CMSIS Stream. Each application contained in the demo is described with a CMSIS Stream graph.

A Python script is used to create such a graph.

By changing the graph, and connecting different nodes, the application can be modified.

To regenerate all the applications after changing a Python description you can do:

```shell
python aidemo.py gen --size --all
```
The `--size` option is a code size optimization explained below in the README.

If you are working on a specific application and want to update it just do:

```shell
python aidemo.py gen --size appa
```
There are 3 applications configured in this demo : `appa`, `appb`, `appc`.

It is also possible to use directly the application scripts without going through the `aidemo` script.

If you want to regenerate the `kws` demo (corresponding to the `appa`), you can do:

```shell 
python -m python.kws --size
```
And if code size optimization is enabled, you need to regenerate the files common to all the apps:

```shell
python -m python.generate appa appb appc
```

It is important to list all the apps in this command.

You need version at least `3.1.0` of the CMSIS Stream Python package. It was recently updated so do a:

```shell
pip install cmsis-stream --upgrade
```

And to be sure the latest CMSIS Stream runtime is used, do a `west update`.


## Code size optimizations

When using several graphs for several applications, the same C++ template may be instantiated several times (in each different app).
Code size optimization is a feature of this demo implemented in `python/generate.py`. It is independent of CMSIS Stream but uses information generated by CMSIS Stream.

Code size optimization is enabled with the `--size` option.
When enabled, and if the `aidemo` script is not used, you should not forget to regenerate the common parts shared between all apps in the demo.

This common part is `src/streamgraph/common/template_instantiations.cpp`  containing instantiations of all templates used in all graphs.
And the templates are no more be instantiated in each graph.

You'll also need `CONFIG_TEMPLATE_INSTANTIATIONS=y` in your `prj.conf` file to build this additional file.


If code size optimization is not enabled, you rely on the linker to remove duplicate C++ template instantiations (and link time optimization should be enabled. It is not enabled in this demo).


## Context switching

This demo allows to switch between several applications by using command `switch` in the Zephyr shell.
Context switching between different graphs is not a feature of CMSIS Stream. It is something built on top of it. But to make this use case easier, the Zephyr module for CMSIS Stream is exposing a tentative API.

Assumptions for context switching are:
  * Several apps in memory
    - We not not destroy / create graphs to context switch.
    - Graph remain in memory
    - It is not as bad as it looks from memory usage point of view since big buffers like display framebuffer of tensor arena are shared between graphs
  * Threads are reused
    - Threads are not linked to a given graph
    - Instead a graph is deployed on existing threads
  * Context switch is cooperative
    - Easier to implement with no constraint on how the drivers (audio, camera ...) have to behave when shared between graphs
    - It should not be a problem : for a real-time demo, node / event processing should not take too much time

# Build issues


## Issues

Zephyr cmakefile for cmsis-dsp module must be changed : `zephyr/modules/cmsis-dsp/CMakeLists.txt`

(since Alif version not yet using the latest Zephyr).

`  zephyr_library_compile_definitions(ZEPHYR_INCLUDE_TOOLCHAIN_STDINT_H_)
` must be added before the `zephyr_library_compile_definitions_ifdef`
to be able to compile with Helium.

