# Zephyr AI projects using CMSIS Stream

Example of use of CMSIS Stream to implement AI + audio + video apps on Alif E7 board.

Several demos are implemented in this application and you can read more details about them [here](doc/demos.md)

Technical details about the demo are [here](doc/tech_details.md).

This version of the demo uses the CMSIS Stream Zephyr module.

You can add it to your west file with:
```
- name: cmsisstream
  url: https://github.com/ARM-software/CMSIS-Stream
  revision: main
  path: modules/lib/cmsisstream
```

The Python script `src/streamgraph/python/kws.py` can be used
to regenerate the KWS example in folder `src/streamgraph/appa`

The Python script `src/streamgraph/python/spectrogram.py` can be used
to regenerate the stereo audio spectrogram example in folder `src/streamgraph/appb`

You need version at least `3.1.0` of the CMSIS Stream Python package. It was recently updated so do a:

```
pip install cmsis-stream --upgrade
```

And to be sure the latest CMSIS Stream runtime is used, do a `west update`.


Other Python scripts in `src\streamgraph\python` have not yet been
updated to use the new directory structure.

## Code size optimizations

When using several graphs for several applications, the same C++ template may be instantiated several times (in each different app).
Code size optimization is a feature of this demo implemented in `src/streamgraph/python/generate.py`. It is independent of CMSIS Stream but uses information generated by CMSIS Stream.


If you want to enable the code size optimization, use the scripts (`kws.py`, `spectrogram.py` ...) with `--size` options.

And when you have generated all graphs, use:

```shell
python ./src/streamgraph/python/generate.py appa appb
```
It will generate `src/streamgraph/common/template_instantiations.cpp`  containing instantiations of all templates used in all graphs.
The templates will no more be instantiated in each graph.

You'll also need `CONFIG_TEMPLATE_INSTANTIATIONS=y` in your `prj.conf` file to build this additional file.


If code size optimization is not enabled, you rely on the linker to remove duplicate C++ template instantiations (and link time optimization should be enabled. It is not enabled in this demo).


## Context switching

This demo allows to switch between several applications by using command `switch` in the Zephyr shell.
Context switching between different graphs is not a feature of CMSIS Stream. It is something built on top of it. But to make this use case easier, the Zephyr module for CMSIS Stream is exposing a tentative API.

Assumptions for context switching are:
  * Several apps in memory
    - We not not destroy / create graphs to context switch.
    - Graph remain in memory
    - It is not as bad as it looks from memory usage point of view since big buffers like display framebuffer of tensor arena are shared between graphs
  * Threads are reused
    - Threads are not linked to a given graph
    - Instead a graph is deployed on existing threads
  * Context switch is cooperative
    - Easier to implement with no constraint on how the drivers (audio, camera ...) have to behave when shared between graphs
    - It should not be a problem : for a real-time demo, node / event processing should not take too much time

# Build issues


## Issues

Zephyr cmakefile for cmsis-dsp module must be changed : `zephyr/modules/cmsis-dsp/CMakeLists.txt`

(since Alif version not yet using the latest Zephyr).

`  zephyr_library_compile_definitions(ZEPHYR_INCLUDE_TOOLCHAIN_STDINT_H_)
` must be added before the `zephyr_library_compile_definitions_ifdef`
to be able to compile with Helium.

